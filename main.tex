\documentclass[11pt]{article}
\pdfoutput=1
\usepackage[margin=1in,a4paper]{geometry}
\usepackage{amsthm,amssymb,amsmath}  
\usepackage{xspace,enumerate}
\usepackage[dvipsnames]{xcolor}
\usepackage[colorlinks=true,urlcolor=Blue,citecolor=Green,linkcolor=BrickRed]{hyperref}
\usepackage[capitalise]{cleveref}
\usepackage[utf8]{inputenc}
\usepackage{thmtools}
\usepackage{thm-restate}
\usepackage{authblk}
\usepackage{todonotes}


\def\dd{\mathinner{.\,.}}
\newcommand{\R}{\mathbb{R}}
\newcommand{\Z}{\mathbb{Z}}
\newcommand{\N}{\mathbb{N}}
\renewcommand{\O}{\mathcal{O}}
\newcommand{\tO}{\tilde{\mathcal{O}}}
\renewcommand{\phi}{\varphi}
\newcommand{\set}[1]{\left\lbrace #1 \right\rbrace}
\newcommand{\floor}[1]{\left\lfloor #1 \right\rfloor}
\newcommand{\bigset}[1]{\big \lbrace #1 \big \rbrace}
\newcommand{\Bigset}[1]{\Big \lbrace #1 \Big \rbrace}
\newcommand{\eq}[1]{\begin{align*} #1 \end{align*}}
\newcommand{\defproblem}[3]{\begin{center}\vspace{2mm}\noindent\fbox{\begin{minipage}{0.96\textwidth} #1 \\ {\bf{INPUT:}} #2 \\ {\bf{OUTPUT:}} #3 \end{minipage}} \vspace{2mm}\end{center}}


\usepackage{microtype} %if unwanted, comment out or use option "draft"
\usepackage{amsmath,amsfonts}
\usepackage[cmbtt]{bold-extra}
\usepackage[T1]{fontenc}
\usepackage[utf8]{inputenc}
\usepackage{thm-restate}
\usepackage{comment}
\usepackage{forest}
\usepackage{xspace}
\usepackage{enumerate}
\usepackage{makecell}
\usepackage{listings}
\usepackage{multirow}
\usepackage{diagbox}
\usepackage{todonotes}
\usepackage{thmtools}
\usepackage[ruled,noline,noend]{algorithm2e}
\usepackage[capitalise]{cleveref}
\usepackage{graphics,adjustbox}
\usepackage{tabularx}
\usepackage{amssymb}
\usepackage{epsfig}
\usepackage{verbatim}
\usepackage{braket}
\usepackage[noadjust]{cite}
\usepackage{xspace}
\usepackage{bold-extra}
\usepackage[margin=1in]{geometry}

\pagestyle{myheadings}


\title{Two-dimensional pattern matching with $k$ mismatches}
\author[1]{Jonas Ellert}
\author[2]{Paweł Gawrychowski}
\author[3]{Adam Górkiewicz}
\author[4]{Tatiana Starikovskaya}
\affil[1]{?}
\affil[2]{?}
\affil[3]{?}
\affil[4]{?}


\theoremstyle{plain}
\newtheorem{theorem}{Theorem}
\newtheorem{lemma}{Lemma}  
\newtheorem{fact}{Fact}
\newtheorem{corollary}[fact]{Corollary}  
\newtheorem{observation}{Observation}
\theoremstyle{definition}
\newtheorem{definition}{Definition}
\newtheorem{example}{Example}
\newtheorem{conjecture}{Conjecture} 
\newtheorem*{claim}{Claim}
\newtheorem{problem}{Problem}
\theoremstyle{remark}
\newtheorem*{remark}{Remark}


\sloppy

\DeclareMathOperator*{\score}{score}
\DeclareMathOperator*{\Ham}{Ham}
\DeclareMathOperator*{\ID}{Id}
\DeclareMathOperator*{\BD}{BorderDis}
\DeclareMathOperator*{\dom}{dom}
\DeclareMathOperator*{\charrr}{C}

\newcommand{\jonas}[2][]{\todo[color=green!40, #1]{\textbf{J:} #2}}
\newcommand{\jonasi}[2][]{\jonas[inline, #1]{#2}}

% BEGIN DOCUMENT
\begin{document}

\date{}
\maketitle

\begin{abstract}
\end{abstract}

%\thispagestyle{empty}
%\clearpage
%\setcounter{page}{1}


\section{Related Work}

\jonasi{work in progress $\downarrow$, unfinished}

\paragraph{Exact PM in 2D}

Assuming $n \times n$ text and $m \times m$ pattern, $m \leq n$.

\begin{itemize}
	\item Two-dimensional pattern matching dates back (at least) to the 1970s, when Richard Bird generalized the Knuth-Morris-Pratt algorithm \cite{Knuth1977} for one-dimensional pattern matching, achieving $\O(n^2 + m^2)$ time \cite{Bird1977}.
	\item By using multiple pattern matching on only $\O(n/m)$ rows of the text, Baeza-Yates and Régnier achieve average time complexity $\O(n^2 / m)$, using $\O(m^2)$ space and still running in $\O(n^2)$ time in the worst case \cite{Baeza-Yates1993}. This was followed by more results optimizing the average time complexity \cite{Tarhio1996,Kaerkkaeinen1999}.
	\item Crochremore at al.\ \cite{Crochemore1995} solve two-dimensional pattern matching space efficiently, using an $\O(m^2)$ time and $\O(\log m)$ space preprocessing followed by an $\O(n^2)$ time and constant space search phase.
	\item On a PRAM, the problem can be solved in constant time and $O(n^2)$ work \cite{Crochemore1998}, after preprocessing the pattern in $\O(\log \log m)$ time and $\O(m^2)$ work \cite{Cole1993}.
	\item Other works studying the problem are, e.g., \cite{Baker1978,Karp1987,Zhu1989,Amir1994,Galil1996}
\end{itemize}


\paragraph{Hamming-Threshold PM in 2D} Assuming $n \times n$ text and $m \times m$ pattern, $m \leq n$, and threshold $k < m^2$.

\begin{itemize}
	\item First result in 1987 by Krithivasan and Sitalakshmi \cite{Krithivasan1987}, who show that $\tO(kmn^2)$ time can be achieved.
	\item Faster algorithm by Rank and Heywood runs in $\tO((k+m)n^2)$ time \cite{Ranka1991}.
	\item Current state of the art\jonas{check} is $\O(kn^2)$ \cite{Amir1991}
	\item More work \cite{Baeza-Yates1998,Park1998,Kaerkkaeinen1999} aimed at optimizing the average time complexity.
\end{itemize}

\paragraph{2D Periodicity}

\begin{itemize}
	\item Two-dimensional periodicity introduced in \cite{Amir1992} and refined in \cite{Galil1996}. All periods (and witnesses for all non-periods) can be computed in $\O(n^2)$ time \cite{Cole2004}.
	\item There can be $\Omega(n^3 \log n)$ tandem substrings (repeated rectangle, like square in a normal string) \cite{Apostolico2000}.
	\item All tandems can be computed in $\O(n^3 \log n)$ time \cite{Apostolico2005}.
	\item There can be $\Omega(n^2 \log n)$ two-dimensional runs (maximal repetitions) \cite{Gawrychowski2021}.
	\item There are at most $\O(n^2 \log^2 n)$ two-dimensional runs \cite{Charalampopoulos2020}.
	\item All runs can be computed in $\O(n^2 \log^2 n)$ time \cite{Amir2020}.
	\item Smallest rectangular cover in $\O(n^2)$ time, all aperiodic covers in $\O(n^2 \log n)$ time \cite{Charalampopoulos2021}.
	\item All tile covers in $\O(n^{2+\epsilon})$ time \cite{Radoszewski2022}.
\end{itemize}


\paragraph{Other 2D Shannanigans}

\jonasi{work in progress, unfinished $\uparrow$}

% INTRODUCTION
\section{Introduction}

\newcommand{\hd}{\textsc{HD1D}\xspace}
\newcommand{\HD}{\textsc{HD2D}\xspace}

We consider the one-dimensional all-substring Hamming distance problem (\hd), where for a given text string $T$ of length $n$ and a string $P$ of length $m$ ($m < n$), we want to calculate the Hamming distance between $P$ and every fragment $T$ of length $m$.

We consider the two-dimensional all-substring Hamming distance problem (\HD), where for a given 2D string $T$ of size $n \times n$ and a string $P$ of size $m \times m$ ($m < n$), we want to calculate the Hamming distance between $P$ and every $m \times m$ fragment of $T$.

We also consider the bounded variants of \hd and \HD, where we are only required to calculate the distances which are not greater than $k$, for some parameter $k \in \Z^+$.


\begin{theorem}[Main result]\label{main result}
	Bounded \HD can be solved in $\tO((m^2 + mk^{5/4})n^2 / m^2)$ time.
\end{theorem}


% PRELIMINARIES
\section{Preliminaries}

For our purposes we will not use the standard definition of a two-dimensional string, where we associate it with a two-dimensional array of characters, and instead we will define it more broadly.
Although we will occasionally use the array notation, we will do it exclusively for $n \times m$ strings.
For any $n \in \Z^+$ we will denote $[n] = \set{0, \dots, n - 1}$.
We will only consider integer points or vectors and we will use these terms interchangeably.
Our results hold under word-RAM model of computation.

\newcommand{\getchar}[1]{\charrr(#1)}
\newcommand{\pto}{\mathrel{\ooalign{\hfil$\mapstochar\mkern5mu$\hfil\cr$\to$\cr}}}
\renewcommand{\d}[1]{\dom(#1)}
\newcommand{\f}[1]{#1^\mathbf{f}}
\begin{definition}[Two-dimensional string]
	We define a \textbf{string} $S$ as a partial function $\Z^2 \pto \Sigma$ which maps some arbitrary set of integer points, denoted as $\d{S}$, to characters.
	For simplicity we will write $u \in S$ to denote that $u \in \d{S}$.
	We say that a string $S$ is \textbf{partitioned} into strings $R_1, \dots, R_\ell$ when the sets $\d{R_1}, \dots, \d{R_\ell}$ partition $\d{S}$ and $R_i(u) = S(u)$ for all $u \in R_i$.
	We call a string $S$ \textbf{monochromatic} when $S(u) = \sigma$ for every $u \in S$ for some $\sigma \in \Sigma$ and we will write $\getchar{S}$ to denote the value $\sigma$.
	We say that $S$ is $n \times m$ for some $n, m \in \Z^+$ when $\d{S} = [n] \times [m]$.
	Physically we represent a string as a list of point-character pairs.
\end{definition}


\begin{definition}[Shifting]
	For a set of points $V \subseteq \Z^2$ and a vector $u \in \Z^2$, we denote $V + u$ as $\set{v + u : v \in V}$.
	For a string $S$ and a vector $u \in \Z^2$ we denote $S + u$ as a string $R$ such that
	$\d{R} = \d{S} + u$ and $R(v) = S(v - u)$ for $v \in \d{R}$.
	Intuitively, we shift the set of points while maintaining their character values.
\end{definition}


\begin{definition}[Hamming distance]
	For a pair of strings $S, R$ we define
	$$ \Ham(S, R) = |\set{u : u \in \d{S} \cap \d{R}, S(u) \neq R(u)}|,$$
	which corresponds to the number of mismatches between $S$ and $R$.
\end{definition}


Under such notation, the \HD problem is equivalent to calculating the (bounded or unbounded) values of $ \Ham(P + q, T) $
for all $q \in \Z^2$ such that $\d{P + q} \subseteq \d{T}$ (so for $q \in [n - m + 1]^2$).


\begin{definition}[Don't care symbol]
	We define the \textbf{don't care} symbol as a special character which matches with every character.
	We will denote it with \texttt{?}.
	Unless stated otherwise, we assume it is not allowed in $\Sigma$ and in both \hd and \HD every character present in $T$ and $P$ matches only with itself.
\end{definition}


\newcommand{\x}[1]{#1.x}
\newcommand{\y}[1]{#1.y}
\newcommand{\h}[1]{\phi \times #1}
\newcommand{\s}[1]{\psi \times #1}
\begin{definition}[Vector operators]
	For any $u \in \Z^2$ we refer to its coordinates as $\x{u}, \y{u}$.
	For $u, v \in \Z^2$ we denote $u \cdot v = \x{u} \cdot \x{v} + \y{u} \cdot \y{v}$
	and $u \times v = \x{u} \cdot \y{v} - \y{u} \cdot \x{v}$.
	Note that alternatively $u \cdot v = |u||v| \cos \alpha$ and $u \times v = |u||v| \sin \alpha$ where $\alpha$ is the angle between $u$ and $v$.
\end{definition}


\newcommand{\Q}{\mathcal{Q}}
\begin{definition}[Quadrants]
	We define the four \textbf{quadrants} as
	\eq{
		\Q_1 &= (0, +\infty) \times [0, +\infty), \\
		\Q_2 &= (-\infty, 0] \times (0, +\infty), \\
		\Q_3 &= (-\infty, 0) \times (-\infty, 0], \\
		\Q_4 &= [0, +\infty) \times (-\infty, 0).
	}
\end{definition}


\section{One-dimensional generalizations}
In this section we explore some of the methods used for one-dimensional strings.
Specifically, as our goal is to generalize the solution for pattern matching with $k$ mismatches described in \cite{Gawrychowski2017}, we are especially interested in two-dimensional variants of the techniques that were used to solve the one-dimensional case.


\begin{theorem}[Instancing]\label{instancing}
	Consider an algorithm $\mathcal{A}$ which solves \HD (bounded or unbounded), but only when $2|n$ and $n \le \frac{3}{2}m$.
	If its running time is $\mathcal{T}(m)$, then the general case can be solved in $\O(\mathcal{T}(m) n^2 / m^2)$.
	\begin{proof}
		Let $r = \floor{m / 2}$ and let $n' = r + m - 1$ or $r + m$ if $r + m - 1$ is odd.
		We see that the set $N = [n']^2$ satisfies the conditions for the text domain.
		For any vector $q \in [n - m]^2$ we can find a vector $u$ such that $r|u.x, r|u.y$ and $q - u \in [r]^2$,
		so we have $\Ham(P + q, T) = \Ham(P + q - u, T_u)$ where $T_u$ is the restriction of $T - u$ to $N$.
		If $T - u$ is not defined for some $v \in N$, we can pad $T_u(v)$ with any character.
		We see that $\d{P + q - u} \subseteq N = \d{T_u}$.
		There are $\O(n^2 / m^2)$ possible vectors $u$ and we run $\mathcal{A}$ for every pair of $T_u$ and $P$.
	\end{proof}
\end{theorem}


\begin{theorem}[Kangaroo jumps]\label{kangaroos}
	Consider an $n \times n$ string $T$, $m \times m$ string $P$ and set of vectors $Q$ such that $\d{P + q} \subseteq \d{T}$ for every $q \in Q$.
	There exists an algorithm which calculates $ d_q = \Ham(P + q, T) $ for every $q \in Q$ in total time $\tO(n^2 + \sum_{q \in Q} d_q)$.
	\begin{proof}
		For the sake of clarity, we will temporarily switch to the classical array notation for strings.
		Let $T_0, \dots, T_{n - m}$ denote an array of two-dimensional strings (arrays) such that $T_k[0 \dd n - 1, 0 \dd m - 1] = T[0 \dd n - 1, k \dd k + m - 1]$.
		For every row $P[0], \dots, P[m - 1]$ of $P$ and every row $T_k[0], \dots, T_k[n - 1]$ of every $T_k$ we assign an integer identifier so that $\ID(P[i]) = \ID(T_k[j]) \Leftrightarrow P[i] = T_k[j]$ by using the KMR algorithm ([reference]) in $\tO(n^2)$.
		
		We use the approach described in [kangaroo reference].
		There exists a data structure (suffix array) which for a given one-dimensional array $S$ allows us to detect all mismatches between any given two of its subarrays of equal length.
		It can be built in $\tO(|S|)$ and the query time is $\tO(d + 1)$ where $d$ is the number of mismatches.
		We construct the suffix array for the concatenation of the following arrays:
		\begin{itemize}
			\item the rows $P[i]$ for every $i$,
			\item the rows $T[i]$ for every $i$,
			\item the array $\ID(P[0]) \ID(P[1]) \dots \ID(P[m - 1])$,
			\item the arrays $\ID(T_k[0]) \ID(T_k[1]) \dots \ID(T_k[n - 1])$ for every $k$,
		\end{itemize}
		the total length of which is $\O(n^2)$.
		Let us consider a problem of detecting mismatches between $P$ and some $T' = T[j \dd j + m - 1, k \dd k + m - 1]$.
		We can first find all row indices $i$ for which $P[i] \neq T'[i]$ by finding all mismatches between $\ID(P[0]) \dots \ID(P[m - 1])$ and $\ID(T_k[j]) \dots \ID(T_k[j + m - 1])$, which we do with query to the data structure.
		For every such $i$ we can then find all mismatches between $P[i]$ and $T'[i]$ by querying $P[i]$ and $T[i + j][k \dd k + m - 1]$.
		If the distance between $P$ and $T'$ is $d$, the first query takes $\tO(d + 1)$ operations and all subsequent queries take $\tO(d + 1)$ operations in total.
	\end{proof}
\end{theorem}


\begin{lemma}\label{sigman1d}
	$\hd$ with don't care symbols can be solved in $\tO(n|\Sigma|)$ by running $|\Sigma|$ instances of FFT.
\end{lemma}


\begin{lemma}\label{approx1d}
	There exists a $(1 + \varepsilon)$-approximate algorithm (introduced in \cite{Karloff1993}) which solves \hd with don't care symbols in $\tO(n)$.
\end{lemma}


\begin{theorem}\label{sigman2d}
	$\HD$ with don't care symbols can be solved in $\tO(n^2|\Sigma|)$.
	\begin{proof}
		We will again use the array notation.
		We construct one-dimensional strings $\bar{T}$ and $\bar{P}$ by concatenating subsequent rows $T[0], \dots, T[n - 1]$ of $T$ and rows $P[0], \dots, P[m - 1]$ of $P$ padded with don't care symbols:
		$$ \bar{T} = T[0] \ T[1] \ \dots \ T[n - 1], $$
		$$ \bar{P} = P[0] \ \texttt{?}^{n - m} \ P[1] \ \texttt{?}^{n - m} \ \dots \ \texttt{?}^{n - m} \ P[m - 1].$$
		We run the algorithm from \Cref{sigman1d}.
		The distance between $T[i \dd i + m - 1, j \dd j + m - 1]$ and $P$ is equal to the distance between $\bar{T}[in + j \dd in + j + nm - n + m - 1]$ and $\bar{P}$.
	\end{proof}
\end{theorem}


\begin{theorem}\label{approx2d}
	There exists a $(1 + \varepsilon)$-approximate algorithm which solves \HD with don't care symbols in $\tO(n^2)$.
	\begin{proof}
		Identical to \Cref{sigman2d}, but we use the algorithm from \Cref{approx1d} instead of \Cref{sigman1d}.
	\end{proof}
\end{theorem}


The same reduction as in \Cref{sigman2d} can be applied for every \hd solution which allows don't care symbols.
Unfortunately, the most effective known algorithms for bounded \hd rely on periodicity (\cite{Clifford2015}, \cite{Gawrychowski2017}) and inherently do not allow don't care symbols, thus, they cannot be easily generalized.


\begin{observation}[Don't care padding]\label{dontcare_padding}
	Every \HD solution which allows don't care symbols (eg. the algorithms from \Cref{sigman2d} and \Cref{approx2d}) can be extended to also calculate the Hamming distance for occurrences of $P$ which are not entirely contained in $T$.
	It can be done by padding the text with don't care symbols and it does not change the complexity of the solution.
\end{observation}


% MAIN ALGORITHM
\section{Proof of \Cref{main result}}
We show an algorithm which works in time $\tO(m^2 + mk^{5/4})$, assuming $2|n$ and $m < n \le \frac{3}{2}m$.
By \Cref{instancing}, our main result follows.

We start by running the algorithm from \Cref{approx2d} with $\varepsilon = 1$.
We construct the set $Q$ as the set of such vectors $q \in \Z^2$ for which the estimated value of $\Ham(P + q, T)$ is at most $2k$.
For every $q \in \set{0, \dots, n - m}^2 \setminus Q$ we say that $\Ham(P + q, T)$ equals $\infty$.
The next step is to calculate the exact value of $\Ham(P + q, T)$ for every $q \in Q$.

Let us consider the case when $|Q| \le 2m + m^2/k$.
We can run the algorithm from \Cref{kangaroos} and by the fact that $\Ham(P + q, T) \le 4k$ for every $q \in Q$, it will perform $\tO(m^2 + mk)$ operations.
We are left with the case when $|Q| > 2m + m^2/k$, in which we take advantage of the fact that some strings $P + q$ for $q \in Q$ must have a large overlap and small Hamming distance from each other, and thus $P$ must be periodic.


\newcommand{\T}{\mathcal{T}}
\renewcommand{\S}{\mathcal{S}}
\renewcommand{\P}{\mathcal{P}}
\newcommand{\U}{\mathcal{U}}
\newcommand{\V}{\mathcal{V}}
\newcommand{\F}{\mathcal{F}}
\renewcommand{\L}{\mathcal{L}}


% 2D PERIODICITY
\subsection{Two-dimensional periodicity} \label{periodicity_section}
In this section we introduce a range of new tools related to two-dimensional periodicity.
We then select some special periods of the pattern and show how to decompose it into some regularly structured monochromatic strings.


\begin{definition}[Periodicity]
	Consider any vector $\delta \in \Z^2$.
	We say that a string $S$ has an $\ell$-period $\delta$ when
	$$ \Ham(S + \delta, S) \le \ell. $$
\end{definition}


\begin{lemma} \label{periodicity_lemma}
	For every $u, v \in Q$, the vector $u - v$ is an $8k$-period of $P$.
	\begin{proof}
		$\Ham(P + u - v, P) = \Ham(P + u, P + v) \le \Ham(P + u, T) + \Ham(P + v, T) \le 4k + 4k. $
	\end{proof}
\end{lemma}


\begin{theorem} \label{get_periods}
	For a given $\ell \in \Z^+$ and a set of points $U \subseteq [\ell + 1]^2 $ such that $|U| > 4\ell$ there exist $s, t, s', t' \in U$ such that the following conditions hold for $w = t - s$ and $w' = t' - s'$:
	\begin{itemize}
		\item $0 < |w||w'| \le 22\frac{\ell^2}{|U|}$,
		\item $|\sin \alpha| \ge \frac{1}{2}$ where $\alpha$ is the angle between $w$ and $w'$,
		\item $w, w', -w, -w'$ are all contained in different quadrants.
	\end{itemize}
	Such $w, w'$ can be found in $\tO(|U|)$ operations.
	\begin{proof} See \Cref{get_periods_proof}. \end{proof}
\end{theorem}


We run the algorithm from \Cref{get_periods} on the set $Q$ (where $\ell = n - m \le m / 2$, thus $|Q| > 2m + m^2/k \ge 4\ell$).
We obtain vectors $\phi \in \Q_4$ and $\psi \in \Q_1$ which by \Cref{periodicity_lemma} are $\O(k)$-periods of $P$.
We will refer to those vectors throughout the rest of the description and we define $p = \phi \times \psi$.
Note that because $|Q| > 2m + m^2 / k$, we have $p \le |\phi||\psi| = \O(\min\set{m, k})$.


\begin{definition}[Lattice congruency]\label{lattice_congruency}
	We define $\L = \set{s\phi + t\psi : s, t \in \Z}$.
	We say that two vectors $u, v \in \Z^2$ are \textbf{lattice-congruent} and denote $u \equiv v$ when $u - v \in \L$ [Galil citation].
\end{definition}


\begin{lemma} \label{lattice_base}
	There exists a set of points $\Gamma \subseteq \Z^2$ such that $|\Gamma| = p$ and every point $u \in \Z^2$ is lattice-congruent to exactly one point $\gamma \in \Gamma$.
	\begin{proof} TODO \end{proof}
\end{lemma}


\begin{definition}[Parquet]\label{parquet_definition}
	We call a non-empty set $U \subseteq \Z^2$ a \textbf{parquet} when there exist some values $x_0, x_1, y_0, y_1, \phi_0, \phi_1, \psi_0, \psi_1 \in \Z$, which we will call its \textbf{signature}, such that
	$$ U = [x_0, x_1) \times [y_0, y_1) \cap \set{u : u \in \Z^2, \h{u} \in [\phi_0, \phi_1), \s{u} \in [\psi_0, \psi_1)}. $$
	\begin{enumerate}[a)]
		\item If additionally $x_1 - x_0 \ge |\x{\phi}| + |\x{\psi}|$ and $y_1 - y_0 \ge |\y{\phi}| + |\y{\psi}|$, then $U$ is a \textbf{spacious} parquet.
		\item If additionally $x_0, y_0 = -\infty$ and $x_1, y_1 = +\infty$, then $U$ is a \textbf{simple} parquet.
	\end{enumerate}
	Note that every simple parquet is spacious.
\end{definition}


\begin{definition}[Subparquet]\label{subparquet_definition}
	We call a non-empty set $V \subseteq \Z^2$ a \textbf{subparquet} when there exists a parquet $U$ and a point $\gamma \in \Z^2$ such that
	$$ V = \set{u : u \in U, u \equiv \gamma}.$$
	We call $V$ a spacious/simple subparquet when there exists $U$ which is (correspondingly) a spacious/simple parquet.
	We say that $V$ is lattice-congruent to some $v \in \Z^2$ (denoted as $V \equiv v$) when $v \equiv \gamma$.
	We similarly define the lattice congruency between two subparquets.
\end{definition}


\begin{theorem}[Subparquet convolution]\label{subparquet_convolution}
	For a given list of signatures of simple subparquets $U_0, \dots, U_{\ell - 1}$, list of signatures of subparquets $V_0, \dots, V_{\ell - 1}$ and a set of vectors $Q$ we can calculate
	$$ \sum_{i = 0}^{\ell - 1} |(U_i + q) \cap V_i| $$
	for every $q \in Q$ in total time $\tO(m^2 + \ell + |Q|)$, assuming that the subparquets only contain vectors of length $\O(m)$.
	\begin{proof} See \Cref{subparquet_convolution_proof}. \end{proof}
\end{theorem}


\begin{definition}[Parquet string]
	We call a string $S$ a spacious/simple (sub-)parquet string when $\d{S}$ is a spacious/simple (sub-)parquet.
\end{definition}


\begin{theorem}[Periodic string decomposition]\label{parquet_decomposition}
	A given spacious/simple parquet string $R$ with $\O(k)$-periods $\phi$ and $\psi$ can be partitioned in time $\tO(|\d{R}|)$ into $\O(k)$ monochromatic spacious/simple subparquet strings, correspondingly.
	\begin{proof} See \Cref{parquet_decomposition_proof}. \end{proof}
\end{theorem}


Since $|\x{\phi}|, |\y{\phi}|, |\x{\psi}|, |\y{\psi}| \le n - m \le m / 2$, the $m \times m$ string $P$ is a spacious parquet string and satisfies the assumptions of \Cref{parquet_decomposition}.
We partition $P$ into a set of strings $\V$.
We then group the strings based on the single character they contain.
Specifically, we construct $\V_\sigma = \set{V : V \in \V, \getchar{V} = \sigma}$ for every character $\sigma \in \Sigma$ present in $P$.


\begin{theorem}\label{sparse_algo}
	For a given set of monochromatic simple subparquet strings $\S$ we can calculate
	$$ \sum_{S \in \S} \Ham(P + q, S) $$
	for every $q \in Q$ in total time $\tO(m^2 + \sum_{S \in \S} |\V_{\getchar{S}}|)$, assuming that the sets $\d{S}$ for $S \in \S$ are some pairwise disjoint subsets of $\d{T}$.
	\begin{proof}
		Let $U = \bigcup_{S \in \S} \d{S}$. Observe that
		$$ \sum_{S \in \S} \Ham(P + q, S) = |(P + q) \cap U| - \sum_{S \in \S}\sum_{V \in \V_{\getchar{S}}} |\d{V + q} \cap \d{S}|.$$
		We can calculate $|(P + q) \cap U|$ for every $q \in Q$ with a single instance of FFT (see \Cref{sigman2d}) or by using prefix sums in time $\tO(m^2)$.
		To calculate the values
		$$ \sum_{S \in \S}\sum_{V \in \V_{\getchar{S}}} |\d{V + q} \cap \d{S}| $$
		we use the algorithm from \Cref{subparquet_convolution} (where $\ell = \sum_{S \in \S} |\V_{\getchar{S}}|$).
	\end{proof}
\end{theorem}


% TEXT DECOMPOSITION
\subsection{Text decomposition}
Because the text is not necessarily periodic, we unfortunately cannot use the same approach as for the pattern.
In this section we show how to decompose $T$ using a similar, but more nuanced approach.


\newcommand{\Ta}{T_\mathbf{a}}
\begin{definition}[Active text]
	We define the \textbf{active text} $\Ta$ as the restriction of $T$ to $\bigcup_{q \in Q} \d{P} + q$.
	For a point $u \in \Z^2$ we define its \textbf{border distance} as
	$\min\set{|u - v| : v \in \Z^2 \setminus \d{\Ta}} $,
	which we will denote as $\BD(u)$.
	For a set of points $U \subseteq \Z^2$, we define $\BD(U) = \max\set{\BD(u) : u \in U}$ and for a string $S$, we define $\BD(S) = \BD(\d{S})$.
	Note that we consider the maximum distance, not minimum.
\end{definition}


\begin{observation}
	$\Ham(P + q, T) = \Ham(P + q, \Ta)$ for every $q \in Q$.
\end{observation}


\begin{theorem}[Active text decomposition]\label{text_decomposition}
	For a given positive integer $\ell \le m$, we can partition the active text in time $\tO(m^2 + \ell k)$ into a set of $\O(\ell k)$ monochromatic simple subparquet strings
	and a string $F$ such that $\BD(F) = \O(m / \ell)$.
	\begin{proof} See \Cref{text_decomposition_proof}. \end{proof}
\end{theorem}


We partition $\Ta$ using the algorithm from \Cref{text_decomposition} with $\ell = mk^{-3/4}$ into a set of simple subparquet strings $\S$ and a string $F$,
where $|\S| = \O(mk^{1/4})$ and $\BD(F) = \O(k^{3 / 4})$.
For every $q \in Q$ we then have
$$ \Ham(P + q, \Ta) = \Ham(P + q, F) + \sum_{S \in \S} \Ham(P + q, S).$$

By \Cref{sparse_algo}, we can calculate $\sum_{S \in \S} \Ham(P + q, S)$ for every $q \in Q$ in time $\tO(m^2 + mk^{5/4})$,
since $\sum_{S \in \S} |\V_{\getchar{S}}| \le |\S| |\V| = \O(mk^{5/4})$.
In the next section we will introduce \Cref{dense_algo}, which states that we can calculate $\Ham(P + q, F)$ for every $q \in Q$ in total time $\tO(m^2 + mk^{1/2} \BD(F))$.
By substituting $\BD(F) = \O(k^{3/4})$, we get the complexity of $\tO(m^2 + mk^{5/4})$, which ends the main proof.


% BORDER PROXIMITY
\subsection{Border proximity}
In this section we explore the properties of strings defined only for the points close to the border.
We consider any non-empty string $S$, such that $\d{S} \subseteq \d{\Ta}$ and let $d = \BD(S)$.
We define a partitioning of $S$ into strings $S_1, \dots, S_4$, by splitting it through the middle with a horizontal and vertical line. 
Specifically
\begin{itemize}
	\item $S_1$ is the restriction of $S$ to $\set{n / 2, \dots, n - 1} \times \set{n / 2, \dots, n - 1}$ (upper right quarter),
	\item $S_2$ is the restriction of $S$ to $\set{0, \dots, n / 2 - 1} \times \set{n / 2, \dots, n - 1}$ (upper left quarter),
	\item $S_3$ is the restriction of $S$ to $\set{0, \dots, n / 2 - 1} \times \set{0, \dots, n / 2 - 1}$ (lower left quarter),
	\item $S_4$ is the restriction of $S$ to $\set{n / 2, \dots, n - 1} \times \set{0, \dots, n / 2 - 1}$ (lower right quarter).
\end{itemize}
We will demonstrate some characteristics of $S_1$, and by symmetry, generalize them to $S$.

\begin{lemma} \label{border_lemma}
	Assuming $d \le m/4$, there does not exist $u \in S_1$ and $v \in T_a$ such that $\x{v} - \x{u} \ge d$ and $\y{v} - \y{u} \ge d$.
	\begin{proof}
		Assume the contrary.
		Since $u \in S_1$, we have $\BD(u) \le d$, so there exists $w \in \Z^2 \setminus \d{\Ta}$ such that
		$\x{u} - d \le \x{w} \le \x{u} + d$ and
		$\y{u} - d \le \y{w} \le \y{u} + d$.
		Since $v \in T_a$, there exists $q \in Q$ such that $v \in [m]^2 + q$.
		We have
		$$ \x{w} \ge \x{u} - d \ge n / 2 - m / 4 \ge n - m > \x{q} $$
		and
		$$ \x{w} \le \x{u} + d \le \x{v} \le \x{q} + m - 1. $$
		Similarly we can show that $\y{q} \le \y{w} \le \y{q} + m - 1$, and thus $w \in [m]^2 + q$.
		Since $[m]^2 + q \subseteq \d{\Ta}$ and $w \not \in \Ta$, we get a contradiction.
	\end{proof}
\end{lemma}

\begin{theorem}\label{sigma_border}
	We can calculate $\Ham(P + q, S)$ for every $q \in Q$ in total time $\tO(m^2 + md |\Sigma|)$, where $|\Sigma|$ is the number of different characters present in both $P$ and $S$.
	\begin{proof} See \Cref{sigma_border_proof}. \end{proof}
\end{theorem}

\begin{theorem}\label{dense_algo}
	We can calculate $\Ham(P + q, S)$ for every $q \in Q$ in total time $\tO(m^2 + mdk^{1/2})$.
	\begin{proof} See \Cref{dense_algo_proof}. \end{proof}
\end{theorem}


\subsubsection{Proof of \Cref{sigma_border}} \label{sigma_border_proof}

We base our approach on the simple method of calculating the Hamming distance by running an instance of FFT for each unique character.
We will again utilize partitioning to reduce the problem to some smaller ones and then solve them naively.

\begin{definition}(width \& height)\label{width_and_height_definition}
	For a non-empty set $U \subseteq \Z^2$ we define its \textbf{width} as $\max\set{\x{u} - \x{v} + 1 : u, v \in U}$
	and its \textbf{height} as $\max\set{\y{u} - \y{v} + 1 : u, v \in U}$.
	For a non-empty string $R$ we define the width and height as the width and height of $\d{R}$.
\end{definition}

\begin{theorem}\label{general_fft}
	Given two non-empty strings $P$ and $T$ of widths $w_P, w_T$ and heights $h_P, h_T$, we can calculate $\Ham(P + q, T)$ for every $q \in \Z^2$, for which the result is non-zero, in total time $\tO((|\Sigma| + 1)(w_P + w_T)(h_P + h_T))$, where $|\Sigma|$ denotes the number of different characters present in both $P$ and $T$.
	\begin{proof}
		We can prove it by slightly generalizing \Cref{sigman2d}, although following the same method, and utilizing \Cref{dontcare_padding}.
	\end{proof}
\end{theorem}

We will assume that $d \le m / 4$, since for $d = \Omega(m)$ we can, by \Cref{general_fft}, calculate the results in time $\tO(m^2 + m^2|\Sigma|)$, which is sufficient.

Recall that 
$\Ham(P + q, S) = \Ham(P + q, S_1) + \dots + \Ham(P + q, S_4)$.
We will only show how to calculate $\Ham(P + q, S_1)$ for every $q \in Q$, since the other cases are symmetric.

We will take advantage of the fact that the points close to the border can overlap only with a small subset of points from the pattern when considering the occurrences fully contained in the active text.
Specifically, let us consider a string $P_0$, defined as the restriction of $P$ to $[m - d]^2$ and a string $P_1$, defined as the restriction of $P$ to $\d{P} \setminus \d{P_0}$.
Since the strings $P_0$ and $P_1$ partition $P$, we have
$$ \Ham(P + q, S_1) = \Ham(P_0 + q, S_1) + \Ham(P_1 + q, S_1).$$

\begin{lemma}\label{border_hamming_reduction}
	$\d{P_0 + q} \cap \d{S_1} = \emptyset$ for every $q \in Q$.
	\begin{proof}
		Let us assume the contrary.
		Select any $q \in Q$ such that $\d{P_0 + q} \cap \d{S_1}$ 
		contains some point $u$ and consider the point $v = (\x{u} + d, \y{u} + d)$.
		Since $u \in [m - d]^2 + q$, we have $v \in [m]^2 + q \subseteq \d{\Ta}$, thus the points $u \in S_1$ and $v \in \Ta$ contradict \Cref{border_lemma}.
	\end{proof}
\end{lemma}

\begin{observation}\label{border_hamming_split}
	$P_1$ can be partitioned into two strings $P_2$ and $P_3$ such that the width of $P_2$ and the height of $P_3$ are equal to $d$.
\end{observation}

By \Cref{border_hamming_reduction}, $\Ham(P_0 + q, S_1) = 0$ for every $q \in Q$
and by \Cref{border_hamming_split} we then have 
$$\Ham(P + q, S_1) = \Ham(P_1 + q, S_1) = \Ham(P_2 + q, S_1) + \Ham(P_3 + q, S_1). $$
for some newly constructed strings $P_2$ and $P_3$, such that the width of $P_2$ and the height of $P_3$ equals $d$.
We calculate $\Ham(P_2 + q, S_1)$ and $\Ham(P_3 + q, S_1)$ for every $Q$ independently and sum the results.
We only show how to calculate $\Ham(P_2 + q, S_1)$, since the other case is symmetric.

We will now partition $S_1$.
Consider an array of strings $U_0, \dots, U_{\lceil n / d \rceil - 1}$, where $U_i$ is the restriction of $S_1$ to $\set{id, \dots, id + d - 1} \times [n] \cap \d{S_1}$.
For the sake of formality (since the maximum/minimum of an empty set is undefined), let $V_0, \dots, V_{\ell - 1}$ consist of all non-empty strings $U_i$, given in the increasing order of $i$.
Observe that $V_0, \dots, V_{\ell - 1}$ partition $S_1$ and their width is not greater than $d$.

For each $i \in [\ell]$ we find $h_i \in \Z^+$, which we define as the minimal number such that $(\x{u}, \y{u} + h_i) \not \in \Ta$ for every $u \in V_i$.

\begin{lemma}\label{sum_of_h}
	The sum of all $h_i$ is $\O(m)$.
	\begin{proof}
		Since for $\ell < 2$, the proof is trivial, we assume $\ell \ge 2$.
		For every $i$ (since $h_i$ is minimal) there exists a point $u_i \in V_i$, such that $(\x{u_i}, \y{u_i} + h_i - 1) \in \Ta$.
		It can be shown that for all $i \ge 2$ we have
		$$ h_{i} \le \y{u_{i - 2}} - \y{u_{i}} + d,$$
		since if that was not the case for some $i$, then the points $u_{i - 2}$ and $v = (\x{u_{i}}, \y{u_{i}} + h_{i} - 1)$ would contradict \Cref{border_lemma}.
		We can conclude that
		$$
			\sum_{i = 0}^{\ell - 1} h_i
			\le h_0 + h_1 + \sum_{i = 2}^{\ell - 1} (\y{u_{i - 2}} - \y{u_i} + d)
			= h_0 + h_1 + \y{u_0} + \y{u_1} - \y{u_{\ell - 2}} - \y{u_{\ell - 1}} + (\ell - 2)d 
			= \O(m).
		$$
	\end{proof}
\end{lemma}


\begin{observation}\label{area_bound}
	For every $i$, the height of $V_i$ is not greater than $h_i$.
	By \Cref{sum_of_h} we have $|S_1| = \O(md)$ and by extension $|S| = \O(md)$.
\end{observation}


For every $i \in [l]$ we construct the string $L_i$ as the restriction of $P_2$ to $[m] \times [m - h_i] \cap \d{P_2}$
and the string $H_i$ as the restriction of $P_2$ to $\d{P_2} \setminus \d{L_i}$.
Since $L_i$ and $H_i$ partition $V_i$, we have
$$ \Ham(P_2 + q, S_1) = \sum_{i = 0}^{\ell - 1} \Ham(P_2 + q, V_i) = \sum_{i = 0}^{\ell - 1} \Ham(L_i + q, V_i) + \sum_{i = 0}^{\ell - 1} \Ham(H_i + q, V_i). $$

\begin{lemma}\label{pattern_height_reduction}
	$\d{L_i + q} \cap \d{V_i} = \emptyset$ for every $q \in Q$ and $i \in [\ell]$.
	\begin{proof}
		Let us assume the contrary.
		Select any $q \in Q$ and $i \in [\ell]$, such that $\d{L_i + q} \cap \d{V_i}$ 
		contains some point $u$ and consider the point $v = (\x{u}, \y{u} + h_i)$.
		Since $u \in [m] \times [m - h_i] + q$, we have $v \in [m]^2 + q \subseteq \d{\Ta}$, thus $v \in \Ta$, which contradicts the definition of $h_i$.
	\end{proof}
\end{lemma}

By \Cref{pattern_height_reduction}, for every $q \in Q$ we have $\sum_{i = 0}^{\ell - 1} \Ham(L_i + q, V_i) = 0$, thus our result is equal to $\sum_{i = 0}^{\ell - 1} \Ham(H_i + q, V_i)$.
We run the algorithm from \Cref{general_fft} for every pair of $H_i$ and $V_i$ and, since both $H_i$ and $V_i$ have widths not greater than $d$ and heights not greater than $h_i$, we obtain the total complexity of $\tO(\sum_{i = 0}^{\ell - 1} (|\Sigma| + 1)dh_i)$, 
which, by \Cref{sum_of_h}, is $\tO(m^2 + md|\Sigma|)$.

\subsubsection{Proof of \Cref{dense_algo}} \label{dense_algo_proof}

Recall the construction of the sets $\V_\sigma$ described in \Cref{periodicity_section}.
We define $\sigma \in \Sigma$ to be a \textbf{frequent} character if $|\V_\sigma| \ge \sqrt{k}$ and if $|\V_\sigma| < \sqrt{k}$, we call it an \textbf{infrequent} character.
\begin{observation}\label{frequent_character_bound}
	The number of different frequent characters is $\O(\sqrt{k})$.
\end{observation}


We partition $S$ into two strings $F$ and $I$, based on character frequency,
so that $F$ consists of only the frequent characters and $I$ consists of only the infrequent ones.
For every $q \in Q$ we then have 
$$\Ham(P + q, S) = \Ham(P + q, F) + \Ham(P + q, I).$$

By \Cref{frequent_character_bound} and \Cref{sigma_border}, we can calculate $\Ham(P + q, F)$ for every $q \in Q$ in total time $\tO(m^2 + mdk^{1/2})$, since $\BD(F) \le d$. 

We partition $I$ into $|\d{I}|$ strings, one per every $u \in I$.
Specifically, let $I_u$ be the restriction of $I$ to $\set{u}$ for every $u \in I$.
We have $\Ham(P + q, I) = \sum_{u \in I} \Ham(P + q, I_u)$ for every $q \in Q$.
By \Cref{subparquet_definition}, $I_u$ are simple subarquet strings, and thus, we can by \Cref{sparse_algo} calculate the results in $\tO(m^2 + \sum_{u \in I} |\V_{I(u)}|)$.
Since $I(u)$ is an infrequent character for every $u \in I$, we have $|\V_{I(u)}| < k^{1/2}$ for every $u \in I$.
By \Cref{area_bound} we have $|\d{I}| = \O(md)$, and thus the total complexity is $\tO(m^2 + mdk^{1/2})$.

% PHI PSI FINDER
\subsection{Proof of \Cref{get_periods}} \label{get_periods_proof}
First, we find any closest pair of vectors $s, t \in U$ by running the standard $\tO(|U|)$ time algorithm and denote $w = t - s$.
We define a partial order $\le_{w}$ where $v \le_w u$ for some $u, v \in U$ when at least one condition holds:
\begin{enumerate}[(a)]
	\item $u = v$,
	\item $u - v$ and $w$ belong to the same quadrant,
	\item $\alpha \in (-\frac{\pi}{6}, \frac{\pi}{6})$ where $\alpha$ is the angle between $w$ and $u - v$.
\end{enumerate}
We find the longest chain $C$ and the longest antichain $A$ using dynamic programming in $\tO(|U|)$ operations.
We then find any closest pair of vectors $s', t' \in A$ and denote $w' = t' - s'$.
We have the following inequalities:
\begin{enumerate}[(i)]
	\item $|U| \le |C| |A|$ (by Dilworth's theorem),
	\item $(|C| - 1) |w| \le (1 + \sqrt{3})\ell$ (roughly by the fact that vectors in $C$ must be increasing in a certain direction), 
	\item $(|A| - 1) |w'| \le 2 \ell$ (by using a similar argument for vectors in $A$).
\end{enumerate}
By considering the assumption $|U| > 4\ell$ it can be proven that $|w||w'| \le 22 \frac{\ell^2}{|U|}$ and the other conditions also hold.


% SUBPARQUET CONVOLUTION
\newcommand{\W}{\mathcal{W}}
\subsection{Proof of \Cref{subparquet_convolution}} \label{subparquet_convolution_proof}
Throughout this section we will denote $D = \set{u : u \in \L, \h{u} \ge 0, \s{u} \ge 0}$, where $\L$ is the set introduced in \Cref{lattice_congruency}.

\begin{lemma}\label{primitive_conv}
	Given a set of subparquets $\V$ and a set of points $Q$, we can calculate
	$$ \sum_{V \in \V} |(D + q) \cap V| $$
	for every $q \in Q$ in total time $\tO(n^2 + |Q| + |\V|)$, assuming that every $V \in \V$ consists of vectors of length $\O(n)$.
	\begin{proof}
		For every $u \in \Z^2$ let us define $\score(u) = |\set{V : V \in \V, u \in V}|$. Observe that
		$$ \sum_{V \in \V} |(D + q) \cap V| = \sum_{u \in D + q} \score(u). $$
		We start by explicitly calculating the scores.
		We find the maximum length of a vector that some $V \in \V$ is defined for, which we denote $\ell$.
		We construct the set $U \subseteq \Z^2$ of all vectors of length at most $\ell$.
		By the assumption, we have $\ell = \O(n)$, and thus $|U| = \O(l ^ 2) = \O(n ^ 2)$.
		We observe that since all the scores are zero for points outside of $U$, we can only calculate them for $u \in U$.
		
		We find the set $\Gamma$ introduced in \Cref{lattice_base} and for every $\gamma \in \Gamma$ we construct $U_\gamma = U \cap (\L + \gamma)$.
		Consider any $u \in U_\gamma$ for some fixed $\gamma \in \Gamma$ and any $V \in \V$.
		We observe that if $V \not \equiv \gamma$, then $u \not \in V$ and thus $V$ does not contribute to $\score(u)$.
		If $V \equiv \gamma$, then we can find a parquet $W$ such that $V = W \cap (\L + \gamma)$ and we have
		$u \in V \Leftrightarrow u \in W \cap (\L + \gamma) \Leftrightarrow u \in W$.
		Thus, if we denote $\W_\gamma$ as the set of parquets $W$ obtained for every $V \in \V$ such that $V \equiv \gamma$, then $\score(u)$ for $u \in U_\gamma$ is the number of parquets $W \in \W_\gamma$ such that $u \in W$.
		We calculate $\score(u)$ for every $u \in U_\gamma$ by sweeping $U_\gamma$ and $\W_\gamma$ in time $\tO(|U_\gamma| + |\W_\gamma|)$.
		We do it independently for every $\gamma \in \Gamma$, performing $\tO(|U| + |\V|) = \tO(n^2 + |\V|)$ operations in total.

		Now consider a query vector $q \in Q$.
		Let $\gamma \in \Gamma$ be such that $q \equiv \gamma$.
		We have already showed that the sum of scores for $u \in D + q$ is equal to the sum of scores for $u \in (D + q) \cap U$.
		Since $(D + q) \cap U = (D + q) \cap U_\gamma$, we see that the result is the sum of scores for such $u \in U_\gamma$, for which $\h{u} \ge \h{q}$ and $\s{u} \ge \s{q}$.
		If we denote $Q_\gamma = Q \cap (\L + \gamma)$, we see that we can calculate the results for all $q \in Q_\gamma$ by sweeping $Q_\gamma$ and $U_\gamma$ in time $\tO(|Q_\gamma| + |U_\gamma|)$.
		We do it independently for every $\gamma \in \Gamma$, performing $\tO(|Q| + |U|) = \tO(n^2 + |Q|)$ operations in total.
	\end{proof}
\end{lemma}

\begin{lemma}\label{primitive}
	For any simple subparquet $U$ we can find $w_0, \dots, w_3 \in \Z^2$ such that
	$$ |U \cap X| = \sum_{j = 0}^3 (-1)^j |(D + w_j) \cap X|$$
	for every $X \subseteq \Z^2$.
	If $U$ consists of vectors of length $\O(n)$, then $w_0, \dots, w_3$ are of length $\O(n)$.
	\begin{proof}
		TODO
	\end{proof}
\end{lemma}

We apply \Cref{primitive} to every $U_i$ and find $w_{i, 0}, \dots, w_{i, 3}$ so that we have
\eq{
	\sum_{i = 0}^{\ell - 1}|(U_i + q) \cap V_i| 
= \sum_{i = 0}^{\ell - 1}|U_i \cap (V_i - q)| 
= \sum_{i = 0}^{\ell - 1} \sum_{j = 0}^3 (-1)^j |(D + w_{i, j}) \cap (V_i - q)| = \\
= \sum_{j = 0}^3 (-1)^j \sum_{i = 0}^{\ell - 1} |(D + q) \cap (V_i - w_{i, j})|.
}
By \Cref{primitive_conv} we can independently calculate the values $\sum_{i = 0}^{\ell - 1} |(D + q) \cap (V_i - w_{i, j})|$ for every $j$ by running the algorithm for $\V_j = \set{V_i - w_{i, j} : i \in [\ell]}$ and $Q$.


% PARQUET DECOMPOSITION
\subsection{Proof of \Cref{parquet_decomposition}} \label{parquet_decomposition_proof}


\begin{definition}[Lattice graph]
	For a set $U \subseteq \Z^2$ we define its \textbf{lattice graph} $G_U = (U, E_U)$ where
	$$ E_U = \bigset{\set{u, u + \delta} : \delta \in \set{\phi, \psi}, u \in U, u + \delta \in U} $$ 
	so every vector is connected with its translations by $\phi, \psi, -\phi, -\psi$.
\end{definition}


\begin{lemma}
	If $U$ is a spacious subparquet, then $G_U$ is connected.
\end{lemma}


Firstly, we partition $R$ into a set of subparquet strings $\S$.
For every non-empty $S \in \S$ we consider a lattice graph $G_{\d{S}}$. If $S$ is not monochromatic, then since $G_{\d{S}}$ is connected, there must exist a pair of neighboring vectors $v, w$ such that $S(v) \neq S(w)$.
We select any such pair and partition $S$ into spacious (or simple if $S$ is simple) subparquet strings $S'$ and $S''$ such that $v \in S'$ and $w \in S''$.
For example if $v = w + \phi$, then $S' = \set{u : u \in S, \s{u} \le \s{v}}$ and $S'' = \set{u : u \in S, \s{u} > \s{v}}$.
In the cases when $v = w + \delta$ for $\delta \in \set{-\phi, \psi, -\psi}$ the construction in similar.

We can recursively partition $S'$ and $S''$ further until we obtain monochromatic strings.
Because $R$ has $\O(k)$-periods $\phi$ and $\psi$, the total number of neighbor pairs $v, w$ such that $S(v) \neq S(w)$ is $\O(k)$ throughout all $S \in \S$.
Thus the total number of recursive calls is $\O(k)$ and because $|\S| = \O(k)$, the total number of constructed strings is $\O(k)$.
The algorithm can be implemented to work in time $\tO(|\d{R}|)$.


% TEXT DECOMPOSITION
\subsection{Proof of \Cref{text_decomposition}} \label{text_decomposition_proof}
Define
\eq{
	a_{\min} &= \min \set{\h{u} : u \in T}, \quad a_{\max} = \max \set{\h{u} : u \in T},\\
	b_{\min} &= \min \set{\s{u} : u \in T}, \quad b_{\max} = \max \set{\s{u} : u \in T}.
}

\begin{lemma}\label{AB_size_bound}
	$|\set{a_{\min}, \dots, a_{\max}}| \le 2n|\phi|$ and $|\set{b_{\min}, \dots, b_{\max}}| \le 2n|\psi|$.
	\begin{proof}
		There exist $u, v \in T$ such that $\h{u} = a_{\min}$ and $\h{v} = a_{\max}$. We have
		\eq{
			|\set{a_{\min}, \dots, a_{\max}}| = 
			a_{\max} - a_{\min} + 1 = \h{v} - \h{u} + 1 = \\
			= \h{(v - u)} + 1 \le |\phi||v - u| + 1 \le |\phi|(2n - 2) + 1 \le 2n|\phi|
		}
		The proof is identical for the second inequality.
	\end{proof}
\end{lemma}

Considering \Cref{AB_size_bound}, we can partition the set $\set{a_{\min}, \dots, a_{\max}}$ into $\ell$ sets $A_0, \dots, A_{\ell - 1}$, such that each $A_i$ contains some subsequent integers ($A_0$ the smallest, $A_{\ell - 1}$ the largest) and $|A_i| \le \lceil 2n|\phi| / \ell \rceil$.
Specifically, 
$ A_i = \set{a_{\min} + id, \dots, a_{\min} + id + d - 1} $, where $d = \lceil |A| / \ell \rceil$.
We identically partition the set $\set{b_{\min}, \dots, b_{\max}}$ into $\ell$ sets $B_0, \dots, B_{\ell - 1}$, such that $|B_i| \le \lceil 2n|\psi| / \ell \rceil$.
Note that $A_i$ and $B_i$ are non-empty.
For every $i, j \in [\ell]$ we construct a simple parquet (recall \Cref{parquet_definition})
$$ U_{i,j} = \set{u : u \in \Z^2, \h{u} \in A_i, \s{u} \in B_j}$$
and for the purpose of the analysis we also define its extension, which includes non-integer points (which we do not explicitly calculate and only use for the proof)
$$ U^\R_{i,j} = \set{u : u \in \R^2, \h{u} \in A_i, \s{u} \in B_j}.$$
Observe that $U^\R_{i, j}$ are non-empty and $U_{i, j}$ might be.
We also define
$$ X_{i, j} = \set{\x{u} : u \in U^\R_{i, j}}, \quad Y_{i, j} = \set{\y{u} : u \in U^\R_{i, j}}.$$

\begin{lemma}\label{distance_bound}
	For every $i, j$ and every $u, v \in U^\R_{i, j}$, we have $|u - v| = \O(n / \ell)$.
	\begin{proof}
		Consider any $u, v \in U^\R_{i, j}$ for some $i, j$ and denote $w = u - v$.
		By \Cref{AB_size_bound} and the fact that $\h{u}$ and $\h{v}$ belong to $A_i$, we have
		$$ |\h{w}| = |\h{(u - v)}| = |\h{u} - \h{v}| \le |A_i| - 1 = \O(n|\phi| / \ell).$$
		We can similarly show that $|\s{w}| = \O(n|\psi| / \ell)$.
		Since $\phi$ and $\psi$ are not collinear, there exist $s, t \in \mathbb{R}$, such that $w = s\phi + t\psi$.
		Recall that by \Cref{get_periods} we have $|\phi \times \psi| \ge \frac{1}{2}|\phi||\psi|$ (since $|\sin \alpha| \ge 1/2$), thus
		$$ \frac{1}{2}|t||\phi||\psi| \le |t||\phi \times \psi| = |\phi \times (s\phi + t\psi)| = |\h{w}| = \O(n|\phi| / \ell), $$
		which gives us $|t\phi| = \O(n / \ell)$.
		We can similarly prove that $|s\psi| = \O(n / \ell)$ and finally
		$$ |w| = |s\phi + t\psi| \le |s\phi| + |t\psi| = \O(n / \ell). $$
	\end{proof}
\end{lemma}


\begin{lemma}
	For every $i \in [\ell - 1]$ and $j \in [\ell]$ we have
	\eq{
		\min X_{i, j} \le \min X_{i + 1, j}, \quad
		&\min Y_{i, j} \le \min Y_{i + 1, j}, \\
		\max X_{i, j} \le \max X_{i + 1, j}, \quad
		&\max Y_{i, j} \le \max Y_{i + 1, j}
	}
	and for every $i \in [\ell]$ and $j \in [\ell - 1]$ we have
	\eq{
		\min X_{i, j} \ge \min X_{i, j + 1}, \quad
		&\min Y_{i, j} \le \min Y_{i, j + 1}, \\
		\max X_{i, j} \ge \max X_{i, j + 1}, \quad
		&\max Y_{i, j} \le \max Y_{i, j + 1}.
	}
	\begin{proof}
		Recall that we selected $\phi \in \Q_4$ and $\psi \in \Q_1$.
		We show the first inequality.
		There exists a point $v \in U^\R_{i + 1, j}$, such that $\x{v} = \min X_{i + 1, j}$.
		Select any $h \in A_i$ and consider a point $u \in \R^2$, such that $\h{u} = h$ and $\s{u} = \s{v}$.
		Observe that $u \in U^\R_{i, j}$.
		Let $w = v - u$.
		There exist $s, t$ such that $w = s\phi + t\psi$.
		We have
		$$ s \phi \times \psi = \s{(s\phi + t\psi)} = \s{w} = \s{v} - \s{u} = 0, $$
		and since $\phi \times \psi > 0$, we get $s = 0$, thus $w = t\psi$.
		Similarly
		$$ t \phi \times \psi = \phi \times t\psi = \h{w} = \h{v} - \h{u} > 0,$$
		and since $\phi \times \psi > 0$, we get $t > 0$. Because $\x{\psi} \ge 0$, we finally have
		$$ \min X_{i, j} \le \x{u} = \x{v} - \x{w} = \x{v} - t\x{\psi} \le \x{v} = \min X_{i + 1, j}. $$
		The other inequalities can be proven analogously.
	\end{proof}
\end{lemma}

We now classify each $U_{i, j}$ into one of six types, numbered from $0$ to $5$.
We say that $U_{i, j}$ is of the $0$th type when
$$ X_{i, j} \times Y_{i, j} \cap (\Z^2 \setminus \d{\Ta}) \neq \emptyset.$$
Note that even though we do not explicitly construct the sets $X_{i, j}$ and $Y_{i, j}$, we can easily check the above condition without doing so (TODO).
For every $U_{i, j}$ that is not of the $0$th type, we have the following classification:
\begin{enumerate}[a)]
	\item If $\min X_{i, j} \ge n / 2$ and $\min Y_{i, j} \ge n / 2$, then $U_{i, j}$ is of the $1$st type (in the upper right quarter).
	\item If $\max X_{i, j}  <  n / 2$ and $\min Y_{i, j} \ge n / 2$, then $U_{i, j}$ is of the $2$nd type (in the upper left quarter).
	\item If $\max X_{i, j}  <  n / 2$ and $\max Y_{i, j}  <  n / 2$, then $U_{i, j}$ is of the $3$rd type (in the lower left quarter).
	\item If $\min X_{i, j} \ge n / 2$ and $\max Y_{i, j}  <  n / 2$, then $U_{i, j}$ is of the $4$th type (in the lower right quarter).
	\item If none of the above is true, then $U_{i, j}$ is of the $5$th type.
\end{enumerate}

% We will denote $C_k$ as the set of all pairs $(i, j)$, such that $U_{i, j}$ is of the $k$th type.
\begin{lemma}\label{border_distance_bound}
	If $U_{i, j}$ is of the $0$th type, then $\BD(U_{i, j}) = \O(n / \ell)$.
	\begin{proof}
		By definition, there exists a point $f \in X_{i, j} \times Y_{i, j} \cap (\Z^2 \setminus \d{\Ta})$.
		There also exists a point $v \in U^\R_{i, j}$ such that $\x{v} = \x{f}$ and a point $w \in U^\R_{i, j}$ such that $\y{w} = \y{f}$.
		By \Cref{distance_bound} we have
		$$ |v - f| = |\y{v} - \y{f}| \le |v - w| = \O(n / \ell).$$
		Since for every $u \in U_{i, j}$, we (by the same lemma) have $|u - v| = \O(n / \ell)$, we get
		$$ |u - f| \le |u - v| + |v - f| = \O(n / \ell).$$
	\end{proof}
\end{lemma}


\begin{lemma}\label{type 5 bound}
	There are $\O(\ell)$ sets $U_{i, j}$ of the $5$th type.
	\begin{proof} See \Cref{type 5 bound proof}. \end{proof}
\end{lemma}

We construct the set $R$ as the sum of all $U_{i, j} \cap \d{\Ta}$, such that $U_{i, j}$ is of the $0$th type.
By \Cref{border_distance_bound}, we have $\BD(R) = \O(n / \ell)$.
Note that the set $R$ and all the sets $U_{i, j}$ of the $1$-$5$ types form a partitioning of $\d{\Ta}$.

We will now merge the $\O(\ell^2)$ sets of the $1$-$5$ types and construct $\O(\ell)$ larger ones.
Since by \Cref{type 5 bound}, the number of sets $U_{i, j}$ of the $5$th type is $\O(\ell)$, we will focus on the $1$-$4$ types.

For every $i \in [\ell]$ we construct the sets
\eq{
	V^1_i = \bigcup_{j = 0}^{\ell - 1} \set{U_{j, i} : U_{j, i} \text{ is of the $1$st type}}, \quad
	V^2_i = \bigcup_{j = 0}^{\ell - 1} \set{U_{i, j} : U_{i, j} \text{ is of the $2$nd type}}, \\
	V^3_i = \bigcup_{j = 0}^{\ell - 1} \set{U_{j, i} : U_{j, i} \text{ is of the $3$rd type}}, \quad
	V^4_i = \bigcup_{j = 0}^{\ell - 1} \set{U_{i, j} : U_{i, j} \text{ is of the $4$th type}}.
}
Consider the family $\U$ consisting of all the sets $V^j_i$ for $i \in [\ell]$, $j \in \set{1, \dots, 4}$ along with all the $U_{i, j}$ sets of the $5$th type.
Observe that $\U \cup \set{R}$ forms a partitioning of $\d{\Ta}$ and that by \Cref{type 5 bound}, $|\U| = \O(\ell)$.

\begin{lemma}
	$\U$ consists of simple parquets.
	\begin{proof}
	\end{proof}
\end{lemma}

Define $\S$.

\begin{lemma}
	$S$ has $\O(k)$-periods $\phi$ and $\psi$ for every $S \in \S$.
	\begin{proof}
	\end{proof}
\end{lemma}

\subsubsection{Proof of \Cref{type 5 bound}} \label{type 5 bound proof}
Every set $U_{i, j}$ of the $5$th type holds at least one of the followig conditions:
\begin{enumerate}
	\item $x_{\min} < n / 2$ and $x_{\max} \ge n / 2$, or \label{condition 1}
	\item $y_{\min} < n / 2$ and $y_{\max} \ge n / 2$.
\end{enumerate}
We will estimate the number of sets satisfying Condition \ref{condition 1}.
Consider the points $u_0, \dots, u_{n - 1}$, where $u_h = (n / 2, h)$.
Observe that every $U_{i, j}$ satisfying Condition \ref{condition 1} must contain some $u_h$.



\bibliographystyle{plain}
\bibliography{references}

\end{document}
